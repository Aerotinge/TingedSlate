####################################################
# EMPEROR events
# By Sergei Ivanov
####################################################
# EMP.12000-EMP.12999

namespace = EMP

character_event = {
    id = EMP.12010
    hide_window = yes

    is_triggered_only = yes # on_death

    trigger = {
		is_member_of_hre = yes
    }

	immediate = {
		any_demesne_title = {
			set_title_flag = hre_reichsfreiheit
		}
	}
}

character_event = {
    id = EMP.12011
    hide_window = yes

    is_triggered_only = yes # on_death

    trigger = {
		offmap_hre = {
			has_status = hre_shattered
			governor = { character = ROOT }
		}
    }

	immediate = {
		any_demesne_title = {
			limit = {
				NOT = {
					tier = EMPEROR
					#title = e_hre
				}
			}
			set_title_flag = hre_kronbesitz
		}
	}
}

character_event = {
    id = EMP.12020
    hide_window = yes

    is_triggered_only = yes # on_new_holder_inheritance

    trigger = {
		offmap_hre = {
			has_status = hre_shattered
		}
		FROM = {
			has_title_flag = hre_reichsfreiheit
		}
    }

	immediate = {
		log = "EMP.12020 triggered [This.GetBestName]"
		if = {
			limit = {
				primary_title = {
					title = FROM
				}
				independent = yes
				NOT = { # No suzerain, which breaks on stupid succ_gavelkind
					suzerain = { always = yes }
				}
			}

			offmap_hre_tributaries_join_effect = yes
		}
		FROM = {
			clr_title_flag = hre_reichsfreiheit
		}
	}
}

character_event = {
    id = EMP.12021
    hide_window = yes

    is_triggered_only = yes # on_new_holder_inheritance

    trigger = {
		offmap_hre = {
			has_status = hre_shattered
		}
		FROM = {
			has_title_flag = hre_kronbesitz
		}
    }

	immediate = {
		log = "EMP.12021 triggered [This.GetBestName]"
		if = { # inherit titles is not the primary_title, nothing happen
			limit = {
				primary_title = {
					FROM = {
						OR = {
							tier = PREV
							lower_tier_than = PREV
						}
						NOT = { title = PREV }
					}
				}
			}
		}
		else_if = { # inherit titles is the primary_title and becomes direct vassal of emperor
			limit = {
				primary_title = {
					title = FROM
				}
				liege = {
					is_offmap_governor = offmap_hre
				}
			}
			set_defacto_liege = THIS
			offmap_hre_tributaries_join_effect = yes
		}
		else = { # inherited titles is the primary_title but not direct vassal of emperor
		}
		FROM = {
			clr_title_flag = hre_kronbesitz
		}
	}
}

character_event = {
	id = EMP.12040
	
	hide_window = yes
	
	is_triggered_only = yes # on_offmap_governor_changed

	trigger = {
		FROMFROM = {
			is_offmap_tag = offmap_hre
			has_status = hre_shattered
		}
	}
	
	immediate = {
		log = "EMP.12040 triggered [This.GetBestName]"
		any_playable_ruler = {
			limit = {
				suzerain = {
					NOT = { is_offmap_governor = offmap_hre }
				}
				OR = {
					is_tributary = { type = hre_prince }
					is_tributary = { type = hre_free_imp_city }
				}
			}
			suzerain = {
				remove_tributary = PREV
			}
			offmap_hre_tributaries_join_effect = yes
		}
	}
	
	after = {
		print_hre_governor_update_effect = yes
		offmap_hre_government_de_facto_maintain_effect = yes
		offmap_hre_ruler_name_sync_effect = yes
	}
}

character_event = {
	id = EMP.12050
	
	hide_window = yes
	offmap = only
	
	is_triggered_only = yes # on_offmap_ruler_changed

	trigger = { is_offmap_tag = offmap_hre }
    
	immediate = {
		print_hre_ruler_update_effect = yes
		offmap_hre_ruler_name_sync_effect = yes
	}
}


character_event = {
    id = EMP.12060
    hide_window = yes

    is_triggered_only = yes # on_new_holder_*

    trigger = {
		offmap_hre = {
			has_status = hre_shattered
			governor_title = {
				OR = {
					persistent_event_target:hre_title_1_per = {
						title = FROM
					}
					persistent_event_target:hre_title_2_per = {
						title = FROM
					}
					persistent_event_target:hre_title_3_per = {
						title = FROM
					}
				}
			}
		}
		is_theocracy = yes
		# TODO: religious check
    }

	immediate = {
		log = "EMP.12060 triggered [This.GetBestName]"
		add_trait = hre_spiritual_elector
	}
}

character_event = {
	id = EMP.12110

	is_triggered_only = yes # on_startup
	
	hide_window = yes
 
	trigger = {
		offmap_hre = {
			governor = {
				character = ROOT
			}
			NOT = { has_offmap_flag = hre_formed }
		}
	}
    
	immediate = {
		e_hre = {
			e_pirates = {
				copy_title_history = PREV
			}
			unsafe_destroy_landed_title = THIS
			activate_title = {
				title = e_hre
				status = no
			}
			copy_title_history = e_pirates
		}
	}
}

character_event = {
	id = EMP.12120

	is_triggered_only = yes # on_unlanded
	
	hide_window = yes
 
	trigger = {
		has_landed_title = e_hre
	}
    
	immediate = {
		log = "EMP.12120 triggered"
		# Shall if current_heir is_landed = NOT
		offmap_hre = {
			clr_offmap_flag = hre_formed
		}
		#e_hre = {
		#	unsafe_destroy_landed_title = THIS
		#}
		# narrative_event
	}
}

# Weak claim for all Princes of hre
character_event = {
	id = EMP.12220

	is_triggered_only = yes # on_offmap_monthly_pulse

	hide_window = yes

	trigger = {
		is_offmap_governor = offmap_hre
		FROM = {
			has_status = hre_shattered
		}
	}

	immediate = {
		log = "EMP.12220 triggered on [This.GetBestName]"
		any_tributary = {
			limit = {
				is_tributary = {
					type = hre_prince
				}
				is_feudal = yes
				NOT = { has_claim = e_hre }
			}

			add_weak_claim = e_hre
			character_event = {
				id = EMP.12221
				days = 30
				random = 30
			}
		}
	}
}

# Maintainace event for event generated weak claim
character_event = {
	id = EMP.12221

	is_triggered_only = yes # EMP.12220

	hide_window = yes

	trigger = {
		is_member_of_hre = yes
		is_feudal = yes
	}

	fail_trigger_effect = {
		if = {
			limit = { has_weak_claim = e_hre }

			remove_claim = e_hre
		}
		break = yes
	}

	immediate = {
		repeat_event = {
			id = EMP.12221
			months = 1
		}
	}
}


# Monthly update - Elector modifier
# Since triggered_modifiers is not working at all
character_event = {
	id = EMP.12222

	is_triggered_only = yes # EMP.12220

	hide_window = yes

	trigger = {
		is_offmap_governor = offmap_hre
		FROM = {
			has_status = hre_shattered
		}
	}

	immediate = {
		FROM = {
			governor_title = {
				any_elector_character = {
					limit = {
						NOT = { character = ROOT }
					}
					remove_character_modifier = hre_elector_modifier
					add_character_modifier = {
						name = hre_elector_modifier
						months = 2
					}
				}
			}
		}
	}
}

narrative_event = {
	id = EMP.12350
	title = EVTNAME_HRE_1350
	desc = EVTDESC_HRE_1350

	#major = yes
	
	#hide_from = yes
	
	picture = "GFX_evt_bloodlines"
	border = "GFX_event_narrative_frame_diplomacy"
	
	only_playable = yes
	religion = catholic
	
	trigger = {
		e_hre = {
			holder_scope = {
				character = ROOT
				war = no
			}
			has_law = succ_feudal_elective
		}
		offmap_hre = {
			AND = {
				always = no
				year = 1350
			}
		}
	}
	
	mean_time_to_happen = {
		months = 36
	}
	
	#major_trigger = {
	#	religion = ROOT
	#}
	
	immediate = {
		hidden_tooltip = {
			offmap_hre = {
				set_status = hre_shattered
				set_offmap_flag = hre_diet_metz_enacted
				governor_title = {
					add_law = {
						law = succ_hre_elective
						opinion_effect = no
					}
					persistent_event_target:hre_title_1_per = {
						holder_scope = {
							if = {
								limit = {
									is_theocracy = yes
								}

								add_trait = hre_spiritual_elector
							}
						}
					}
					persistent_event_target:hre_title_2_per = {
						holder_scope = {
							if = {
								limit = {
									is_theocracy = yes
								}

								add_trait = hre_spiritual_elector
							}
						}
					}
					persistent_event_target:hre_title_3_per = {
						holder_scope = {
							if = {
								limit = {
									is_theocracy = yes
								}

								add_trait = hre_spiritual_elector
							}
						}
					}
				}
			}
			set_government_type = sacred_confederacy_government
			offmap_hre_government_de_facto_maintain_effect = yes
			offmap_hre_ruler_name_sync_effect = yes
			export_to_variable = {
				which = global_current_year
				value = year
			}
			character_event = { id = EMP.12220 } # generate weak claim for all princes
		}
	}
	
	option = {
		name = EVTOPTA8000 # I guess I have no choice...
		trigger = {
			any_realm_title = {
				title = e_hre
			}
		}
	}
	option = {
		name = CURSES
		trigger = {
			NOT = {
				any_realm_title = {
					title = e_hre
				}
			}
			OR = {
				has_claim = e_hre
				is_heir = e_hre
			}
		}
	}
	option = {
		name = EVTOPTA_MNM_4610 # EVTOPTB_HRE_1350;That's nice, I guess.;C'est bien, je suppose.;Das ist ganz nett, denke ich.;;Está bien, supongo.;;;;;;;;;x
		trigger = {
			NOT = {
				any_realm_title = {
					title = e_hre
				}
			}
			NOR = {
				has_claim = e_hre
				is_heir = e_hre
			}
		}
	}
	
	after = {
		hidden_tooltip = {
			set_variable = {
				which = global_current_year
				value = 0
			}
		}
	}
}